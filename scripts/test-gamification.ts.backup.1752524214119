import GamificationService from '../src/services/gamificationService';

async function testGamificationSystem() {
  console.log('ğŸ§ª Iniciando pruebas del sistema de gamificaciÃ³n...\n');

  try {
    // Test 1: Procesar respuesta de usuario
    console.log('ğŸ“ Test 1: Procesando respuesta de usuario...');
    const userResponse = await GamificationService.processUserResponse({
      telegramUserId: '123456789',
      username: 'test_user',
      firstName: 'Usuario',
      lastName: 'Prueba',
      questionId: 'test-question-1',
      telegramMsgId: '1001',
      isCorrect: true,
      responseTime: 15
    });

    console.log('âœ… Respuesta procesada:', {
      puntos: userResponse.totalPoints,
      nivel: userResponse.level,
      racha: userResponse.streak,
      ranking: userResponse.rank
    });

    // Test 2: Obtener estadÃ­sticas del usuario
    console.log('\nğŸ“Š Test 2: Obteniendo estadÃ­sticas del usuario...');
    const userStats = await GamificationService.getUserStats('123456789');
    
    if (userStats) {
      console.log('âœ… EstadÃ­sticas obtenidas:', {
        totalResponses: userStats.totalResponses,
        correctResponses: userStats.correctResponses,
        accuracy: userStats.accuracy,
        level: userStats.level
      });
    }

    // Test 3: Obtener ranking general
    console.log('\nğŸ† Test 3: Obteniendo ranking general...');
    const leaderboard = await GamificationService.getLeaderboard(5);
    console.log('âœ… Top 5 usuarios:', leaderboard.map(entry => ({
      rank: entry.rank,
      user: entry.user.username || entry.user.firstName,
      points: entry.points,
      level: entry.level
    })));

    // Test 4: Procesar mÃ¡s respuestas para probar rachas
    console.log('\nğŸ”¥ Test 4: Probando sistema de rachas...');
    
    // Simular respuestas en dÃ­as consecutivos
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    
    await GamificationService.processUserResponse({
      telegramUserId: '123456789',
      username: 'test_user',
      firstName: 'Usuario',
      lastName: 'Prueba',
      questionId: 'test-question-2',
      telegramMsgId: '1002',
      isCorrect: true,
      responseTime: 12,
      responseDate: yesterday
    });

    const updatedStats = await GamificationService.getUserStats('123456789');
    console.log('âœ… Racha actualizada:', {
      racha: updatedStats?.streak,
      mejorRacha: updatedStats?.bestStreak
    });

    // Test 5: Verificar logros
    console.log('\nğŸ… Test 5: Verificando logros desbloqueados...');
    const achievements = await GamificationService.getUserAchievements('123456789');
    console.log('âœ… Logros desbloqueados:', achievements.map(ach => ({
      name: ach.achievement.name,
      points: ach.achievement.points,
      unlockedAt: ach.unlockedAt.toLocaleDateString()
    })));

    // Test 6: Ranking semanal
    console.log('\nğŸ“… Test 6: Obteniendo ranking semanal...');
    const weeklyLeaderboard = await GamificationService.getWeeklyLeaderboard(3);
    console.log('âœ… Top 3 semanal:', weeklyLeaderboard.map(entry => ({
      rank: entry.rank,
      user: entry.user.username || entry.user.firstName,
      points: entry.points
    })));

    // Test 7: EstadÃ­sticas generales
    console.log('\nğŸ“ˆ Test 7: Obteniendo estadÃ­sticas generales...');
    const generalStats = await GamificationService.getGeneralStats();
    console.log('âœ… EstadÃ­sticas generales:', {
      totalUsers: generalStats.totalUsers,
      totalResponses: generalStats.totalResponses,
      averageAccuracy: `${generalStats.averageAccuracy}%`,
      activeStreaks: generalStats.activeStreaks
    });

    console.log('\nğŸ‰ Â¡Todas las pruebas completadas exitosamente!');
    console.log('\nğŸ“‹ Resumen del sistema:');
    console.log('- âœ… Procesamiento de respuestas');
    console.log('- âœ… Sistema de puntos y niveles');
    console.log('- âœ… Rachas diarias');
    console.log('- âœ… Logros automÃ¡ticos');
    console.log('- âœ… Rankings mÃºltiples');
    console.log('- âœ… EstadÃ­sticas completas');

  } catch (error) {
    console.error('âŒ Error en las pruebas:', error);
    
    if (error instanceof Error) {
      console.error('Detalles del error:', error.message);
      console.error('Stack trace:', error.stack);
    }
    
    process.exit(1);
  }
}

// FunciÃ³n para limpiar datos de prueba
async function cleanupTestData() {
  console.log('\nğŸ§¹ Limpiando datos de prueba...');
  
  try {
    const { PrismaClient } = await import('@prisma/client');
    const prisma = new PrismaClient();

    // Eliminar datos de prueba
    await prisma.userAchievement.deleteMany({
      where: {
        user: {
          telegramUserId: '123456789'
        }
      }
    });

    await prisma.telegramResponse.deleteMany({
      where: {
        user: {
          telegramUserId: '123456789'
        }
      }
    });

    await prisma.weeklyStats.deleteMany({
      where: {
        user: {
          telegramUserId: '123456789'
        }
      }
    });

    await prisma.telegramUser.deleteMany({
      where: {
        telegramUserId: '123456789'
      }
    });

    console.log('âœ… Datos de prueba eliminados');
    await prisma.$disconnect();
    
  } catch (error) {
    console.error('âŒ Error limpiando datos:', error);
  }
}

// Ejecutar pruebas
async function runTests() {
  await testGamificationSystem();
  
  // Preguntar si limpiar datos de prueba
  console.log('\nâ“ Â¿Deseas limpiar los datos de prueba? (y/N)');
  
  // En un entorno real, podrÃ­as usar readline para input del usuario
  // Por ahora, comentamos la limpieza automÃ¡tica
  // await cleanupTestData();
  
  console.log('\nğŸ’¡ Para limpiar manualmente los datos de prueba, ejecuta:');
  console.log('npx tsx scripts/cleanup-test-data.ts');
}

runTests(); 