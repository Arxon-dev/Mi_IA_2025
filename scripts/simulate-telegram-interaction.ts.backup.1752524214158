import GamificationService from '../src/services/gamificationService';

// Simulador de interacciones de Telegram para testing
interface SimulatedTelegramUser {
  id: string;
  username?: string;
  firstName: string;
  lastName?: string;
}

interface SimulatedQuestion {
  id: string;
  text: string;
  correctAnswer: string;
  options: string[];
}

class TelegramSimulator {
  private users: SimulatedTelegramUser[] = [
    { id: '123456789', username: 'juan_estudiante', firstName: 'Juan', lastName: 'PÃ©rez' },
    { id: '987654321', username: 'maria_quiz', firstName: 'MarÃ­a', lastName: 'GarcÃ­a' },
    { id: '456789123', firstName: 'Carlos', lastName: 'LÃ³pez' },
    { id: '789123456', username: 'ana_smart', firstName: 'Ana', lastName: 'MartÃ­n' },
    { id: '321654987', firstName: 'Luis', lastName: 'Rodriguez' }
  ];

  private questions: SimulatedQuestion[] = [
    {
      id: 'q1',
      text: 'Â¿CuÃ¡l es la capital de EspaÃ±a?',
      correctAnswer: 'A',
      options: ['Madrid', 'Barcelona', 'Valencia', 'Sevilla']
    },
    {
      id: 'q2',
      text: 'Â¿En quÃ© aÃ±o se descubriÃ³ AmÃ©rica?',
      correctAnswer: 'B',
      options: ['1491', '1492', '1493', '1494']
    },
    {
      id: 'q3',
      text: 'Â¿CuÃ¡l es el planeta mÃ¡s grande del sistema solar?',
      correctAnswer: 'C',
      options: ['Tierra', 'Marte', 'JÃºpiter', 'Saturno']
    },
    {
      id: 'q4',
      text: 'Â¿QuiÃ©n escribiÃ³ Don Quijote?',
      correctAnswer: 'A',
      options: ['Cervantes', 'GarcÃ­a Lorca', 'Machado', 'GÃ³ngora']
    },
    {
      id: 'q5',
      text: 'Â¿CuÃ¡ntos continentes hay?',
      correctAnswer: 'D',
      options: ['5', '6', '8', '7']
    }
  ];

  private getRandomUser(): SimulatedTelegramUser {
    return this.users[Math.floor(Math.random() * this.users.length)];
  }

  private getRandomQuestion(): SimulatedQuestion {
    return this.questions[Math.floor(Math.random() * this.questions.length)];
  }

  private getRandomResponseTime(): number {
    // Simular diferentes velocidades de respuesta (5-60 segundos)
    return Math.floor(Math.random() * 55) + 5;
  }

  private getRandomAnswer(): string {
    const answers = ['A', 'B', 'C', 'D'];
    return answers[Math.floor(Math.random() * answers.length)];
  }

  async simulateUserResponse(user?: SimulatedTelegramUser, question?: SimulatedQuestion, forceCorrect?: boolean): Promise<void> {
    const selectedUser = user || this.getRandomUser();
    const selectedQuestion = question || this.getRandomQuestion();
    const responseTime = this.getRandomResponseTime();
    
    let userAnswer: string;
    if (forceCorrect !== undefined) {
      userAnswer = forceCorrect ? selectedQuestion.correctAnswer : this.getRandomAnswer();
    } else {
      // 70% de probabilidad de respuesta correcta
      userAnswer = Math.random() < 0.7 ? selectedQuestion.correctAnswer : this.getRandomAnswer();
    }
    
    const isCorrect = userAnswer === selectedQuestion.correctAnswer;

    console.log(`ğŸ“ ${selectedUser.firstName} responde "${userAnswer}" a: ${selectedQuestion.text}`);
    console.log(`   ${isCorrect ? 'âœ… Correcto!' : 'âŒ Incorrecto'} (respuesta: ${selectedQuestion.correctAnswer}) - ${responseTime}s`);

    const result = await GamificationService.processUserResponse({
      telegramUserId: selectedUser.id,
      username: selectedUser.username,
      firstName: selectedUser.firstName,
      lastName: selectedUser.lastName,
      questionId: selectedQuestion.id,
      telegramMsgId: Date.now().toString(),
      isCorrect,
      responseTime
    });

    console.log(`   ğŸ“Š Resultado: ${result.totalPoints} pts, Nivel ${result.level}, Ranking #${result.rank}\n`);
  }

  async simulateMultipleResponses(count: number = 10): Promise<void> {
    console.log(`ğŸ² Simulando ${count} respuestas aleatorias...\n`);
    
    for (let i = 0; i < count; i++) {
      await this.simulateUserResponse();
      // PequeÃ±a pausa para simular tiempo real
      await new Promise(resolve => setTimeout(resolve, 100));
    }
  }

  async simulateStreak(user: SimulatedTelegramUser, days: number = 5): Promise<void> {
    console.log(`ğŸ”¥ Simulando racha de ${days} dÃ­as para ${user.firstName}...\n`);
    
    for (let day = 0; day < days; day++) {
      console.log(`--- DÃ­a ${day + 1} ---`);
      
      // Simular 1-3 respuestas por dÃ­a
      const responsesPerDay = Math.floor(Math.random() * 3) + 1;
      
      for (let resp = 0; resp < responsesPerDay; resp++) {
        // Simular que las respuestas fueron en dÃ­as diferentes
        const originalProcessUserResponse = GamificationService.processUserResponse;
        
        // Temporalmente modificar la fecha para simular dÃ­as diferentes
        // (En un caso real esto no serÃ­a necesario)
        
        await this.simulateUserResponse(user, undefined, true); // Forzar respuestas correctas para la racha
        await new Promise(resolve => setTimeout(resolve, 50));
      }
      
      console.log('');
    }
  }

  async showLeaderboard(): Promise<void> {
    console.log('ğŸ† RANKING ACTUAL ğŸ†\n');
    
    const leaderboard = await GamificationService.getLeaderboard(10);
    
    leaderboard.forEach((entry, index) => {
      const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : 'ğŸ”¸';
      const name = entry.user.username || entry.user.firstName || 'Usuario';
      
      console.log(`${medal} ${entry.rank}. ${name}`);
      console.log(`   ğŸ“Š ${entry.points} pts | ğŸ¯ Nv.${entry.level} | ğŸ”¥ ${entry.streak} dÃ­as\n`);
    });
  }

  async showWeeklyLeaderboard(): Promise<void> {
    console.log('ğŸ“… RANKING SEMANAL ğŸ“…\n');
    
    const weeklyLeaderboard = await GamificationService.getWeeklyLeaderboard(5);
    
    weeklyLeaderboard.forEach((entry, index) => {
      const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : 'ğŸ”¸';
      const name = entry.user.username || entry.user.firstName || 'Usuario';
      
      console.log(`${medal} ${entry.rank}. ${name}`);
      console.log(`   ğŸ“Š ${entry.points} pts esta semana\n`);
    });
  }

  async showUserStats(userId: string): Promise<void> {
    const stats = await GamificationService.getUserStats(userId);
    
    if (!stats) {
      console.log(`âŒ No se encontraron estadÃ­sticas para el usuario ${userId}`);
      return;
    }

    const user = this.users.find(u => u.id === userId);
    const name = user ? (user.username || user.firstName) : 'Usuario';

    console.log(`ğŸ“Š ESTADÃSTICAS DE ${name.toUpperCase()} ğŸ“Š\n`);
    console.log(`ğŸ† Puntos totales: ${stats.totalPoints}`);
    console.log(`ğŸ¯ Nivel: ${stats.level}`);
    console.log(`ğŸ”¥ Racha actual: ${stats.streak} dÃ­as`);
    console.log(`ğŸ… Mejor racha: ${stats.bestStreak} dÃ­as`);
    console.log(`ğŸ“ˆ Ranking: #${stats.rank}`);
    console.log(`ğŸ“ Respuestas totales: ${stats.totalResponses}`);
    console.log(`âœ… Respuestas correctas: ${stats.correctResponses}`);
    console.log(`ğŸ¯ PrecisiÃ³n: ${stats.accuracy}%\n`);
  }
}

// Script principal
async function runSimulation() {
  const simulator = new TelegramSimulator();
  
  console.log('ğŸ® SIMULADOR DE INTERACCIONES DE TELEGRAM ğŸ®\n');
  console.log('Este simulador te permite probar el sistema de gamificaciÃ³n sin necesidad del webhook real.\n');

  try {
    // 1. Simular actividad inicial
    console.log('='.repeat(50));
    console.log('ğŸ¯ FASE 1: Actividad inicial');
    console.log('='.repeat(50));
    await simulator.simulateMultipleResponses(15);

    // 2. Mostrar ranking inicial
    console.log('='.repeat(50));
    console.log('ğŸ† FASE 2: Ranking despuÃ©s de actividad inicial');
    console.log('='.repeat(50));
    await simulator.showLeaderboard();

    // 3. Simular racha para un usuario especÃ­fico
    console.log('='.repeat(50));
    console.log('ğŸ”¥ FASE 3: Simulando racha de usuario dedicado');
    console.log('='.repeat(50));
    const dedicatedUser = { id: '123456789', username: 'juan_estudiante', firstName: 'Juan', lastName: 'PÃ©rez' };
    await simulator.simulateStreak(dedicatedUser, 7);

    // 4. Mostrar estadÃ­sticas del usuario dedicado
    console.log('='.repeat(50));
    console.log('ğŸ“Š FASE 4: EstadÃ­sticas del usuario dedicado');
    console.log('='.repeat(50));
    await simulator.showUserStats('123456789');

    // 5. MÃ¡s actividad general
    console.log('='.repeat(50));
    console.log('ğŸ² FASE 5: MÃ¡s actividad general');
    console.log('='.repeat(50));
    await simulator.simulateMultipleResponses(20);

    // 6. Rankings finales
    console.log('='.repeat(50));
    console.log('ğŸ† FASE 6: Rankings finales');
    console.log('='.repeat(50));
    await simulator.showLeaderboard();
    console.log('');
    await simulator.showWeeklyLeaderboard();

    console.log('='.repeat(50));
    console.log('ğŸ‰ Â¡SIMULACIÃ“N COMPLETADA!');
    console.log('='.repeat(50));
    console.log('âœ… Sistema de gamificaciÃ³n funcionando correctamente');
    console.log('ğŸ“Š Revisa el dashboard en: http://localhost:3000/dashboard/gamification');
    console.log('ğŸ¤– Cuando tengas el webhook configurado, el sistema funcionarÃ¡ automÃ¡ticamente');

  } catch (error) {
    console.error('âŒ Error en la simulaciÃ³n:', error);
  }
}

// Ejecutar si es llamado directamente
if (require.main === module) {
  runSimulation();
}

export { TelegramSimulator }; 