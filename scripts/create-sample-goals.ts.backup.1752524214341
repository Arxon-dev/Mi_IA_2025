import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function createSampleGoals() {
  console.log('ğŸ¯ CREANDO METAS DE EJEMPLO');
  console.log('==========================');
  console.log('');

  try {
    // Obtener usuarios existentes
    const users = await prisma.telegramUser.findMany({
      select: {
        id: true,
        telegramUserId: true,
        firstName: true,
        username: true
      }
    });

    if (users.length === 0) {
      console.log('âŒ No hay usuarios para crear metas');
      return;
    }

    console.log(`ğŸ“Š Encontrados ${users.length} usuarios`);
    console.log('');

    // Tipos de metas que vamos a crear
    const goalTemplates = [
      {
        type: 'weekly',
        target: 50,
        reward: 100,
        daysToComplete: 7,
        description: 'Ganar 50 puntos esta semana'
      },
      {
        type: 'daily',
        target: 3,
        reward: 25,
        daysToComplete: 1,
        description: 'Responder 3 preguntas hoy'
      },
      {
        type: 'monthly',
        target: 200,
        reward: 300,
        daysToComplete: 30,
        description: 'Ganar 200 puntos este mes'
      },
      {
        type: 'weekly',
        target: 7,
        reward: 150,
        daysToComplete: 7,
        description: 'Mantener racha de 7 dÃ­as'
      },
      {
        type: 'custom',
        target: 10,
        reward: 75,
        daysToComplete: 5,
        description: 'Responder 10 preguntas en 5 dÃ­as'
      }
    ];

    // Crear metas para cada usuario
    for (const user of users) {
      console.log(`ğŸ‘¤ Creando metas para ${user.firstName} (@${user.username || 'sin_username'})`);
      
      // Cada usuario tendrÃ¡ 2-4 metas aleatorias
      const numGoals = Math.floor(Math.random() * 3) + 2; // 2-4 metas
      const selectedGoals = goalTemplates
        .sort(() => 0.5 - Math.random())
        .slice(0, numGoals);

      for (const goalTemplate of selectedGoals) {
        // Calcular fecha lÃ­mite
        const deadline = new Date();
        deadline.setDate(deadline.getDate() + goalTemplate.daysToComplete);

        // Simular progreso (0-80% para que no todas estÃ©n completadas)
        const currentProgress = Math.floor(Math.random() * (goalTemplate.target * 0.8));
        const isCompleted = currentProgress >= goalTemplate.target;

        try {
          const goal = await prisma.userGoal.create({
            data: {
              userId: user.id,
              type: goalTemplate.type,
              target: goalTemplate.target,
              current: currentProgress,
              reward: goalTemplate.reward,
              deadline: deadline,
              completed: isCompleted
            }
          });

          console.log(`   âœ… ${goalTemplate.type}: ${currentProgress}/${goalTemplate.target} (${goalTemplate.reward} pts)`);
        } catch (error) {
          console.log(`   âŒ Error creando meta ${goalTemplate.type}:`, error);
        }
      }
      console.log('');
    }

    // Mostrar estadÃ­sticas finales
    const totalGoals = await prisma.userGoal.count();
    const completedGoals = await prisma.userGoal.count({ where: { completed: true } });
    const activeGoals = await prisma.userGoal.count({ where: { completed: false } });

    console.log('ğŸ“Š ESTADÃSTICAS FINALES:');
    console.log('========================');
    console.log(`ğŸ¯ Total metas creadas: ${totalGoals}`);
    console.log(`âœ… Metas completadas: ${completedGoals}`);
    console.log(`ğŸ”„ Metas activas: ${activeGoals}`);
    console.log('');

    // Mostrar distribuciÃ³n por tipo
    const goalsByType = await prisma.userGoal.groupBy({
      by: ['type'],
      _count: { type: true }
    });

    console.log('ğŸ“ˆ DISTRIBUCIÃ“N POR TIPO:');
    goalsByType.forEach(stat => {
      const emoji = getGoalTypeEmoji(stat.type);
      console.log(`${emoji} ${stat.type}: ${stat._count.type} metas`);
    });

  } catch (error) {
    console.error('âŒ Error creando metas de ejemplo:', error);
  } finally {
    await prisma.$disconnect();
  }
}

function getGoalTypeEmoji(type: string): string {
  switch (type.toLowerCase()) {
    case 'daily': return 'ğŸ“…';
    case 'weekly': return 'ğŸ“ˆ';
    case 'monthly': return 'ğŸ—“ï¸';
    case 'custom': return 'ğŸ¯';
    default: return 'â­';
  }
}

// FunciÃ³n para mostrar ejemplos de lo que verÃ¡n los usuarios
function showExampleOutputs() {
  console.log('');
  console.log('ğŸ® EJEMPLOS DE LO QUE VERÃN LOS USUARIOS:');
  console.log('========================================');
  console.log('');
  
  console.log('ğŸ“± COMANDO: /metas');
  console.log('');
  console.log('ğŸ¯ TUS METAS ğŸ¯');
  console.log('');
  console.log('ğŸ”„ METAS ACTIVAS (3):');
  console.log('');
  console.log('ğŸ“ˆ Meta Semanal');
  console.log('ğŸ“ˆ Progreso: 35/50 (70%)');
  console.log('â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘ 70%');
  console.log('ğŸ’° Recompensa: +100 pts');
  console.log('â° 3 dÃ­as restantes');
  console.log('');
  console.log('ğŸ“… Meta Diaria');
  console.log('ğŸ“ˆ Progreso: 1/3 (33%)');
  console.log('â–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘ 33%');
  console.log('ğŸ’° Recompensa: +25 pts');
  console.log('â° ğŸš¨ 1 dÃ­a restante');
  console.log('');
  console.log('âœ… METAS COMPLETADAS RECIENTES:');
  console.log('');
  console.log('ğŸ—“ï¸ Meta Mensual âœ…');
  console.log('ğŸ† 200/200 - 15/12/2024');
  console.log('ğŸ’° +300 pts obtenidos');
  console.log('');
  console.log('ğŸ“Š ESTADÃSTICAS DE METAS:');
  console.log('ğŸ† Completadas: 5');
  console.log('ğŸ”„ Activas: 3');
  console.log('ğŸ’ Puntos ganados: 875');
  console.log('');
  console.log('ğŸš€ Â¡Sigue trabajando en tus metas!');
}

async function main() {
  await createSampleGoals();
  showExampleOutputs();
}

main().catch(console.error); 