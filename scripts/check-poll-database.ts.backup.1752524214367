import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function checkPollDatabase() {
  try {
    console.log('üîç VERIFICANDO BASE DE DATOS');
    console.log('============================');
    
    // Verificar polls en la base de datos
    console.log('üìä Buscando polls registrados...');
    const polls = await prisma.telegramPoll.findMany({
      orderBy: { sentAt: 'desc' },
      take: 5
    });
    
    console.log(`‚úÖ Encontrados ${polls.length} polls:`);
    polls.forEach((poll, index) => {
      console.log(`   ${index + 1}. Poll ID: ${poll.pollId}`);
      console.log(`      Pregunta ID: ${poll.questionId}`);
      console.log(`      Enviado: ${poll.sentAt.toLocaleString()}`);
      console.log(`      Respuesta correcta: Opci√≥n ${poll.correctAnswerIndex}`);
      console.log(`      Chat ID: ${poll.chatId}`);
      console.log('');
    });
    
    // Verificar usuarios registrados
    console.log('üë• Verificando usuarios registrados...');
    const users = await prisma.telegramUser.findMany();
    console.log(`‚úÖ Encontrados ${users.length} usuarios:`);
    users.forEach((user, index) => {
      console.log(`   ${index + 1}. ${user.firstName} (@${user.username || 'sin_username'})`);
      console.log(`      Telegram ID: ${user.telegramUserId}`);
      console.log(`      Puntos: ${user.totalPoints}`);
      console.log(`      Se uni√≥: ${user.joinedAt.toLocaleString()}`);
      console.log('');
    });
    
    // Verificar respuestas registradas
    console.log('üí¨ Verificando respuestas registradas...');
    const responses = await prisma.telegramResponse.findMany({
      orderBy: { answeredAt: 'desc' },
      take: 10,
      include: {
        user: {
          select: {
            firstName: true,
            username: true
          }
        }
      }
    });
    
    console.log(`‚úÖ Encontradas ${responses.length} respuestas:`);
    responses.forEach((response, index) => {
      console.log(`   ${index + 1}. ${response.user.firstName} (@${response.user.username || 'sin_username'})`);
      console.log(`      Pregunta ID: ${response.questionId}`);
      console.log(`      Correcto: ${response.isCorrect ? '‚úÖ' : '‚ùå'}`);
      console.log(`      Puntos: ${response.points}`);
      console.log(`      Respondido: ${response.answeredAt.toLocaleString()}`);
      console.log('');
    });
    
    // Buscar espec√≠ficamente la pregunta final
    console.log('üéØ Buscando la pregunta final espec√≠ficamente...');
    const finalPoll = await prisma.telegramPoll.findFirst({
      where: {
        pollId: '5890795620695803130' // Poll ID de la pregunta final
      }
    });
    
    if (finalPoll) {
      console.log('‚úÖ Pregunta final encontrada en la base de datos:');
      console.log(`   Poll ID: ${finalPoll.pollId}`);
      console.log(`   Pregunta ID: ${finalPoll.questionId}`);
      console.log(`   Respuesta correcta: Opci√≥n ${finalPoll.correctAnswerIndex}`);
      console.log(`   Enviado: ${finalPoll.sentAt.toLocaleString()}`);
    } else {
      console.log('‚ùå La pregunta final NO se encontr√≥ en la base de datos');
      console.log('   Esto explica por qu√© no se procesan las respuestas');
    }
    
  } catch (error) {
    console.error('‚ùå Error verificando base de datos:', error);
  } finally {
    await prisma.$disconnect();
  }
}

checkPollDatabase(); 