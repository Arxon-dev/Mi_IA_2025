import cron from 'node-cron';
import { prisma } from '../src/lib/prisma';
import fs from 'fs';
import path from 'path';

const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN || '8039179482:AAG6bugxwgsmWLVHGoWpE5nih_PQpD3KPBs';
const CHAT_ID = process.env.TELEGRAM_CHAT_ID || '-1002352049779';

interface WeeklyRankingUser {
  telegramUserId: string;
  firstName: string;
  username?: string;
  weeklyPoints: number;
  weeklyResponses: number;
  weeklyCorrect: number;
  weeklyIncorrect: number;
  weeklyAccuracy: number;
  avgResponseTime: number;
  level: number;
  totalPoints: number;
}

interface SchedulerConfig {
  rankings?: {
    weekly?: {
      enabled: boolean;
      frequency: string;
      cronExpression: string;
      topUsersCount: number;
      showAccuracy: boolean;
      showAverageTime: boolean;
      includeMemes: boolean;
      showComparison: boolean;
    };
  };
}

type FrequencyKey = 'test' | 'hourly' | 'every3h' | 'every4h' | 'every6h' | 'daily' | 'evening' | 'weekly';

let currentSchedule: any | null = null;

// ğŸ¯ FRASES MOTIVACIONALES SEMANALES
const WEEKLY_MEMES = [
  "ğŸ”¥ Â¡Esta semana fue intensa! Â¿QuiÃ©n dominÃ³ el juego?",
  "âš¡ Â¡Los nÃºmeros semanales estÃ¡n calientes! ğŸ“Š",
  "ğŸ¯ Semana completada. Â¿QuiÃ©n se llevÃ³ la corona?",
  "ğŸ’ª 7 dÃ­as de pura acciÃ³n intelectual. Â¡Veamos los resultados!",
  "ğŸŒŸ Ranking semanal: donde las leyendas nacen cada 7 dÃ­as",
  "ğŸ† Una semana mÃ¡s en los libros. Â¡Estos son sus campeones!",
  "ğŸ® Game over para esta semana. Â¡AquÃ­ estÃ¡n los high scores!",
  "ğŸ“ˆ Los datos no mienten: esta semana tuvo nivel Ã©pico",
  "â­ Otra semana, otra oportunidad de brillar. Â¡Y estos brillaron!",
  "ğŸš€ Houston, tenemos un ranking semanal. Â¡Despegamos!"
];

// âš™ï¸ CARGAR CONFIGURACIÃ“N DEL SCHEDULER
function loadSchedulerConfig(): SchedulerConfig {
  try {
    const configPath = path.join(process.cwd(), 'scheduler-config.json');
    if (fs.existsSync(configPath)) {
      const configData = fs.readFileSync(configPath, 'utf8');
      return JSON.parse(configData);
    }
  } catch (error) {
    console.error('âŒ Error cargando configuraciÃ³n:', error);
  }
  
  // ConfiguraciÃ³n por defecto
  return {
    rankings: {
      weekly: {
        enabled: true,
        frequency: 'every4h',
        cronExpression: '0 */4 * * *',
        topUsersCount: 8,
        showAccuracy: true,
        showAverageTime: true,
        includeMemes: true,
        showComparison: true
      }
    }
  };
}

function getFixedWeekDates(date: Date = new Date()) {
  const currentDate = new Date(date);
  
  // Encontrar el lunes de esta semana
  const dayOfWeek = currentDate.getDay();
  const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Domingo = 0, convertir a 6
  
  const mondayOfWeek = new Date(currentDate);
  mondayOfWeek.setDate(currentDate.getDate() - daysFromMonday);
  mondayOfWeek.setHours(0, 0, 0, 0);
  
  // Domingo de esta semana
  const sundayOfWeek = new Date(mondayOfWeek);
  sundayOfWeek.setDate(mondayOfWeek.getDate() + 6);
  sundayOfWeek.setHours(23, 59, 59, 999);
  
  return {
    weekStart: mondayOfWeek,
    weekEnd: sundayOfWeek,
    weekLabel: `${mondayOfWeek.getDate()}/${mondayOfWeek.getMonth() + 1} - ${sundayOfWeek.getDate()}/${sundayOfWeek.getMonth() + 1}`
  };
}

async function fetchWeeklyRankingData(): Promise<WeeklyRankingUser[]> {
  console.log('ğŸ“Š Obteniendo datos del ranking semanal FIJO...');

  try {
    // ğŸ”§ FIX: Usar semana fija (lunes a domingo) en lugar de mÃ³vil
    const { weekStart: currentWeekStart, weekEnd: currentWeekEnd, weekLabel } = getFixedWeekDates();
    
    console.log(`ğŸ—“ï¸ Semana fija (${weekLabel}): ${currentWeekStart.toISOString()} hasta: ${currentWeekEnd.toISOString()}`);

    // ENFOQUE SEGURO: Obtener usuarios con respuestas de la semana
    const usersWithWeeklyResponses = await prisma.telegramUser.findMany({
      where: {
        responses: {
          some: {
            answeredAt: {
              gte: currentWeekStart,
              lte: currentWeekEnd
            }
          }
        }
      },
      select: {
        telegramUserId: true,
        firstName: true,
        username: true,
        level: true,
        totalPoints: true,
        responses: {
          where: {
            answeredAt: {
              gte: currentWeekStart,
              lte: currentWeekEnd
            }
          },
          select: {
            points: true,
            isCorrect: true,
            responseTime: true
          }
        }
      }
    });

    console.log(`ğŸ‘¥ Encontrados ${usersWithWeeklyResponses.length} usuarios con actividad semanal`);

    // Calcular estadÃ­sticas semanales por usuario
    const weeklyUsers: WeeklyRankingUser[] = usersWithWeeklyResponses.map(user => {
      const responses = user.responses;
      
      const weeklyPoints = responses.reduce((sum, r) => sum + (r.points || 0), 0);
      const weeklyResponses = responses.length;
      const weeklyCorrect = responses.filter(r => r.isCorrect).length;
      const weeklyIncorrect = weeklyResponses - weeklyCorrect;
      const weeklyAccuracy = weeklyResponses > 0 
        ? Math.round((weeklyCorrect / weeklyResponses) * 100)
        : 0;
      
      const totalResponseTime = responses.reduce((sum, r) => sum + (r.responseTime || 0), 0);
      const avgResponseTime = weeklyResponses > 0 
        ? Math.round(totalResponseTime / weeklyResponses)
        : 0;

      return {
        telegramUserId: user.telegramUserId,
        firstName: user.firstName || 'Usuario',
        username: user.username || undefined,
        weeklyPoints,
        weeklyResponses,
        weeklyCorrect,
        weeklyIncorrect,
        weeklyAccuracy,
        avgResponseTime,
        level: user.level,
        totalPoints: user.totalPoints
      };
    });

    // Ordenar por puntos semanales
    const sortedUsers = weeklyUsers.sort((a, b) => b.weeklyPoints - a.weeklyPoints);
    
    console.log(`ğŸ“Š Procesadas estadÃ­sticas de ${sortedUsers.length} usuarios`);
    if (sortedUsers.length > 0) {
      console.log(`ğŸ† LÃ­der semanal: ${sortedUsers[0].firstName} con ${sortedUsers[0].weeklyPoints} puntos`);
    }
    
    return sortedUsers;
    
  } catch (error) {
    console.error('âŒ Error obteniendo datos semanales:', error);
    // Retornar array vacÃ­o en caso de error para que el mensaje se genere
    return [];
  }
}

function generateWeeklyRankingMessage(users: WeeklyRankingUser[]): string {
  const schedulerConfig = loadSchedulerConfig();
  const config = schedulerConfig.rankings?.weekly || {
    enabled: true,
    frequency: 'every4h',
    cronExpression: '0 */4 * * *',
    topUsersCount: 8,
    showAccuracy: true,
    showAverageTime: true,
    includeMemes: true,
    showComparison: true
  };
  const now = new Date();
  const timeStr = now.toLocaleTimeString('es-ES', { 
    hour: '2-digit', 
    minute: '2-digit' 
  });
  const dateStr = now.toLocaleDateString('es-ES', { 
    day: 'numeric', 
    month: 'numeric', 
    year: 'numeric' 
  });

  // Obtener informaciÃ³n de la semana actual
  const { weekLabel } = getFixedWeekDates();

  // Emojis aleatorios para hacer mÃ¡s dinÃ¡mico
  const weeklyEmojis = ['ğŸ“ˆ', 'ğŸƒâ€â™‚ï¸', 'âš¡', 'ğŸ”¥', 'ğŸ“Š', 'ğŸ¯'];
  const randomEmoji = weeklyEmojis[Math.floor(Math.random() * weeklyEmojis.length)];

  let message = `ğŸ† <b>RANKING SEMANAL</b> ğŸ†\n`;
  message += `ğŸ“… ${dateStr} - ğŸ• ${timeStr}\n`;
  message += `ğŸ“Š <i>Semana del ${weekLabel}</i>\n\n`;

  if (users.length === 0) {
    message += 'ğŸ“Š <i>No hay actividad esta semana</i>\n\n';
    message += 'ğŸ’¡ Â¡Responde preguntas para aparecer en el ranking semanal!';
    return message;
  }

  const topUsers = users.slice(0, config.topUsersCount);
  const totalWeeklyPoints = users.reduce((sum, user) => sum + user.weeklyPoints, 0);
  const totalWeeklyResponses = users.reduce((sum, user) => sum + user.weeklyResponses, 0);

  topUsers.forEach((user, index) => {
    const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : 
                 index === 3 ? 'ğŸ…' : 'ğŸ”¸';
    const name = user.username || user.firstName || 'Usuario';
    
    message += `${medal} <b>${index + 1}.</b> ${name}\n`;
    message += `   ğŸ“Š ${user.weeklyPoints} pts esta semana | ${getLevelEmoji(user.level)} Nv.${user.level}\n`;
    message += `   ğŸ“ ${user.weeklyResponses} respuestas | âœ… ${user.weeklyCorrect} aciertos`;
    
    if (user.weeklyIncorrect > 0) {
      message += ` | âŒ ${user.weeklyIncorrect} fallos`;
    }
    
    if (config.showAccuracy && user.weeklyResponses > 0) {
      const accuracyEmoji = user.weeklyAccuracy >= 80 ? 'ğŸ¯' : user.weeklyAccuracy >= 60 ? 'ğŸ“ˆ' : 'ğŸ“Š';
      message += ` | ${accuracyEmoji} ${user.weeklyAccuracy}%`;
    }
    
    if (config.showAverageTime && user.avgResponseTime > 0) {
      const speedEmoji = user.avgResponseTime <= 15 ? 'âš¡' : user.avgResponseTime <= 30 ? 'ğŸƒ' : 'ğŸš¶';
      message += ` | ${speedEmoji} ${user.avgResponseTime}s`;
    }
    
    message += '\n\n';
  });

  // EstadÃ­sticas generales de la semana
  const activeUsers = users.length;
  const topPerformer = users[0];
  const avgAccuracy = users.length > 0 
    ? Math.round(users.reduce((sum, u) => sum + u.weeklyAccuracy, 0) / users.length)
    : 0;

  message += `ğŸ“ˆ <b>RESUMEN SEMANAL:</b>\n`;
  message += `ğŸ‘¥ ${activeUsers} usuarios activos esta semana\n`;
  message += `ğŸ“Š ${totalWeeklyResponses} respuestas totales\n`;
  message += `ğŸ¯ ${avgAccuracy}% precisiÃ³n promedio\n`;
  message += `ğŸ† LÃ­der: ${topPerformer.firstName} (${topPerformer.weeklyPoints} pts esta semana)\n\n`;

  // Frases motivacionales aleatorias
  if (config.includeMemes) {
    const weeklyPhrases = [
      'ğŸ”¥ Â¡Semana intensa de estudio!',
      'ğŸ“ˆ Â¡El progreso semanal es excelente!',
      'âš¡ Â¡Esta semana han volado las respuestas!',
      'ğŸ¯ Â¡PrecisiÃ³n semanal en aumento!',
      'ğŸ’ª Â¡Una semana mÃ¡s cerca de la plaza!',
      'ğŸš€ Â¡Despegue semanal hacia el Ã©xito!',
      'ğŸ“š Â¡Semana de estudio intensivo!',
      'ğŸ† Â¡Champions de la semana!',
      'â­ Â¡Semana estelar de preparaciÃ³n!',
      'ğŸª Â¡El show semanal continÃºa!'
    ];
    
    const randomPhrase = weeklyPhrases[Math.floor(Math.random() * weeklyPhrases.length)];
    message += randomPhrase + '\n\n';
  }

  // CTAs ACCIONABLES MEJORADOS
  message += `ğŸ¯ <b>VE TU POSICIÃ“N:</b>\n`;
  message += `â€¢ <code>/ranking</code> - Ranking completo actual\n`;
  message += `â€¢ <code>/mi_stats</code> - Tu rendimiento detallado\n`;
  message += `â€¢ <code>/estadisticas</code> - Tus nÃºmeros completos\n\n`;

  message += `ğŸ’¡ <b>Â¿QUIERES SUBIR EN EL RANKING?</b>\n`;
  if (topPerformer) {
    const topUserName = topPerformer.username || topPerformer.firstName;
    message += `â€¢ <code>/duelo @${topUserName}</code> - Reta al #1 de la semana\n`;
  }
  message += `â€¢ <code>/torneo</code> - Ãšnete al prÃ³ximo torneo\n`;
  message += `â€¢ <code>/torneos</code> - Ver torneos disponibles\n`;
  message += `â€¢ <code>/simulacro</code> - Practica intensiva\n`;
  message += `â€¢ <code>/falladas10</code> - Repasar errores\n\n`;

  message += `ğŸ”¥ <b>Â¡La prÃ³xima semana podrÃ­as ser tÃº el #1!</b>\n`;
  message += `ğŸ’ª Estudia, compite y supera tus lÃ­mites`;

  return message;
}

function getLevelEmoji(level: number): string {
  if (level >= 10) return 'ğŸ’';
  if (level >= 8) return 'ğŸ‘‘';
  if (level >= 6) return 'ğŸ†';
  if (level >= 4) return 'â­';
  if (level >= 2) return 'ğŸ”¥';
  return 'ğŸ“–';
}

async function sendWeeklyRankingMessage(message: string): Promise<boolean> {
  try {
    console.log('ğŸ“¤ Enviando ranking semanal automÃ¡tico...');
    
    const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: CHAT_ID,
        text: message,
        parse_mode: 'HTML'
      })
    });

    const result = await response.json() as any;
    
    if (result.ok) {
      console.log(`âœ… Ranking semanal enviado exitosamente (ID: ${result.result.message_id})`);
      return true;
    } else {
      console.error('âŒ Error en respuesta de Telegram:', result);
      return false;
    }
  } catch (error) {
    console.error('âŒ Error enviando ranking semanal:', error);
    return false;
  }
}

/**
 * ğŸŒ™ Verificar si estamos en horario permitido (NO entre 22:00 y 08:00)
 */
function isAllowedHour(): boolean {
  const now = new Date();
  const hour = now.getHours();
  
  // NO enviar entre 22:00 (22) y 08:00 (8)
  const isNightTime = hour >= 22 || hour < 8;
  
  return !isNightTime;
}

async function generateAndSendWeeklyRanking(): Promise<void> {
  try {
    const schedulerConfig = loadSchedulerConfig();
    const config = schedulerConfig.rankings?.weekly;
    
    if (!config?.enabled) {
      console.log('â¸ï¸ Ranking semanal deshabilitado en configuraciÃ³n');
      return;
    }
    
    // ğŸŒ™ VERIFICAR HORARIO PERMITIDO
    if (!isAllowedHour()) {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('es-ES', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      console.log(`ğŸŒ™ Ranking semanal omitido - Horario nocturno (${timeStr})`);
      console.log('ğŸ’¤ Respetando horas de descanso (22:00-08:00)');
      return;
    }
    
    console.log('\nğŸ“ˆ ===== GENERANDO RANKING SEMANAL AUTOMÃTICO =====');
    console.log(`â° Frecuencia activa: ${config.frequency}`);
    console.log(`ğŸ¯ ConfiguraciÃ³n: Top ${config.topUsersCount} usuarios`);
    
    const users = await fetchWeeklyRankingData();
    const message = generateWeeklyRankingMessage(users);
    const success = await sendWeeklyRankingMessage(message);
    
    if (success) {
      console.log('ğŸ‰ Ranking semanal automÃ¡tico completado exitosamente');
      
      // Log de estadÃ­sticas para debugging
      console.log('ğŸ“Š Resumen semanal enviado:', {
        activeUsers: users.length,
        topUser: users[0] ? `${users[0].firstName} (${users[0].weeklyPoints} pts)` : 'No hay usuarios',
        totalWeeklyPoints: users.reduce((sum, u) => sum + u.weeklyPoints, 0)
      });
    } else {
      console.error('âŒ Fallo en el envÃ­o del ranking semanal automÃ¡tico');
    }
    
  } catch (error) {
    console.error('âŒ Error en generateAndSendWeeklyRanking:', error);
  }
}

function startWeeklyRankingScheduler(): void {
  console.log('ğŸš€ Iniciando Weekly Ranking Scheduler...');
  
  const updateScheduler = () => {
    try {
      // Detener scheduler actual si existe
      if (currentSchedule) {
        currentSchedule.stop();
        currentSchedule = null;
      }

      const schedulerConfig = loadSchedulerConfig();
      const config = schedulerConfig.rankings?.weekly;
      
      if (!config?.enabled) {
        console.log('â¸ï¸ Weekly Ranking Scheduler deshabilitado en configuraciÃ³n');
        return;
      }

      const cronExpression = config.cronExpression || '0 */4 * * *';
      
      console.log(`â° Programando ranking semanal: ${cronExpression}`);
      console.log(`ğŸ“Š Top usuarios: ${config.topUsersCount}`);
      
      // Crear nuevo scheduler
      currentSchedule = cron.schedule(cronExpression, async () => {
        console.log('ğŸ”” Ejecutando ranking semanal programado...');
        await generateAndSendWeeklyRanking();
      }, {
        timezone: "America/Mexico_City"
      });

      console.log('âœ… Weekly Ranking Scheduler iniciado correctamente');
      
    } catch (error) {
      console.error('âŒ Error configurando scheduler semanal:', error);
    }
  };

  // Configurar scheduler inicial
  updateScheduler();

  // Vigilar cambios en configuraciÃ³n cada 30 segundos
  setInterval(() => {
    updateScheduler();
  }, 30000);

  console.log('ğŸ‘ï¸ Vigilancia de configuraciÃ³n activa (cada 30s)');
}

// ğŸƒâ€â™‚ï¸ PUNTO DE ENTRADA
async function main(): Promise<void> {
  const args = process.argv.slice(2);
  
  if (args.includes('--test')) {
    console.log('ğŸ§ª Modo de prueba: ejecutando ranking semanal una vez...');
    await generateAndSendWeeklyRanking();
    process.exit(0);
  } else {
    console.log('ğŸ”„ Modo scheduler: iniciando servicio continuo...');
    startWeeklyRankingScheduler();
    
    // Mantener el proceso vivo
    process.on('SIGINT', () => {
      console.log('\nâ¹ï¸ Deteniendo Weekly Ranking Scheduler...');
      if (currentSchedule) {
        currentSchedule.stop();
      }
      process.exit(0);
    });

    console.log('âœ… Weekly Ranking Scheduler ejecutÃ¡ndose. Presiona Ctrl+C para detener.');
  }
}

// ğŸš€ EJECUTAR
main().catch(error => {
  console.error('ğŸ’¥ Error fatal en Weekly Ranking Scheduler:', error);
  process.exit(1);
}); 