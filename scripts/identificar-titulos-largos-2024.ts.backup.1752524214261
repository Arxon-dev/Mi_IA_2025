import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function identificarTitulosLargos() {
  console.log('ğŸ” IDENTIFICANDO TÃTULOS LARGOS EN EXAMEN 2024...\n');
  
  try {
    const allQuestions = await (prisma as any).examenOficial2024.findMany({
      orderBy: { questionNumber: 'asc' }
    });
    
    console.log(`ğŸ“‹ Total de preguntas: ${allQuestions.length}\n`);
    
    const preguntasConTitulosLargos = [];
    const patronesComunes = new Map();
    
    allQuestions.forEach((question: any) => {
      // Calcular longitud total del poll (con headers)
      const header = `ğŸ¯ SIMULACRO EXAMEN 2024 - Pregunta ${question.questionNumber}/100\nâ° Tiempo restante: 2h 52m\n`;
      const totalLength = header.length + question.question.length;
      
      // Identificar patrones comunes de tÃ­tulos largos
      const questionText = question.question;
      
      // Patrones a buscar
      if (questionText.includes('InstrucciÃ³n 14/2021, por la que se desarrolla la OrganizaciÃ³n del E.T.')) {
        const key = 'InstrucciÃ³n 14/2021 ET';
        if (!patronesComunes.has(key)) patronesComunes.set(key, []);
        patronesComunes.get(key)?.push(question.questionNumber);
      }
      
      if (questionText.includes('ConstituciÃ³n EspaÃ±ola. Del Gobierno y la AdministraciÃ³n.')) {
        const key = 'ConstituciÃ³n EspaÃ±ola Gobierno';
        if (!patronesComunes.has(key)) patronesComunes.set(key, []);
        patronesComunes.get(key)?.push(question.questionNumber);
      }
      
      if (questionText.includes('Real Decreto')) {
        const key = 'Real Decreto';
        if (!patronesComunes.has(key)) patronesComunes.set(key, []);
        patronesComunes.get(key)?.push(question.questionNumber);
      }
      
      if (questionText.includes('Ley OrgÃ¡nica')) {
        const key = 'Ley OrgÃ¡nica';
        if (!patronesComunes.has(key)) patronesComunes.set(key, []);
        patronesComunes.get(key)?.push(question.questionNumber);
      }
      
      // Si es muy largo (mÃ¡s de 300 caracteres total)
      if (totalLength > 300) {
        preguntasConTitulosLargos.push({
          questionNumber: question.questionNumber,
          totalLength,
          questionLength: question.question.length,
          questionPreview: question.question.substring(0, 100) + '...',
          needsShortening: true
        });
      }
    });
    
    console.log('ğŸ“ PREGUNTAS CON TÃTULOS LARGOS (>300 caracteres total):');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    
    if (preguntasConTitulosLargos.length > 0) {
      preguntasConTitulosLargos.forEach((p: any) => {
        console.log(`\nâŒ Pregunta ${p.questionNumber}: [${p.totalLength} chars total]`);
        console.log(`   ğŸ“ "${p.questionPreview}"`);
      });
    } else {
      console.log('âœ… No se encontraron preguntas que excedan los 300 caracteres');
    }
    
    console.log('\n\nğŸ·ï¸ PATRONES COMUNES IDENTIFICADOS:');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    
    patronesComunes.forEach((preguntas, patron) => {
      console.log(`\nğŸ“‹ "${patron}": ${preguntas.length} preguntas`);
      console.log(`   Preguntas: ${preguntas.join(', ')}`);
    });
    
    console.log('\n\nğŸ’¡ SUGERENCIAS DE ABREVIACIÃ“N:');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('ğŸ”¸ "InstrucciÃ³n 14/2021, por la que se desarrolla la OrganizaciÃ³n del E.T." â†’ "INST. 14/2021, ET"');
    console.log('ğŸ”¸ "ConstituciÃ³n EspaÃ±ola. Del Gobierno y la AdministraciÃ³n." â†’ "C.E. Gobierno y Admin."');
    console.log('ğŸ”¸ "Real Decreto" â†’ "RD"');
    console.log('ğŸ”¸ "Ley OrgÃ¡nica" â†’ "L.O."');
    
    console.log(`\nğŸ“Š RESUMEN:`);
    console.log(`âŒ Preguntas que necesitan acortamiento: ${preguntasConTitulosLargos.length}`);
    console.log(`ğŸ“‹ Patrones identificados: ${patronesComunes.size}`);
    
  } catch (error) {
    console.error('âŒ Error identificando tÃ­tulos:', error);
  } finally {
    await prisma.$disconnect();
  }
}

identificarTitulosLargos(); 