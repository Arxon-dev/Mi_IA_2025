import { PrismaClient } from '@prisma/client';
import Examen2024Service from '../src/services/examen2024Service';
import Simulacro2024Service from '../src/services/simulacro2024Service';

const prisma = new PrismaClient();

async function testExamen2024Integration() {
  console.log('üß™ PROBANDO INTEGRACI√ìN DEL EXAMEN 2024...\n');
  
  try {
    // Test 1: Verificar que las preguntas del examen 2024 est√°n disponibles
    console.log('üìã Test 1: Verificando preguntas del examen 2024...');
    const questionCount = await prisma.examenOficial2024.count();
    console.log(`‚úÖ Preguntas disponibles: ${questionCount}`);
    
    if (questionCount === 0) {
      console.error('‚ùå No hay preguntas del examen 2024 en la base de datos');
      return;
    }
    
    // Test 2: Verificar que se puede obtener una pregunta aleatoria
    console.log('\nüìã Test 2: Obteniendo pregunta aleatoria...');
    const randomQuestion = await Examen2024Service.getRandomQuestion();
    
    if (randomQuestion) {
      console.log('‚úÖ Pregunta obtenida correctamente:');
      console.log(`   - N√∫mero: ${randomQuestion.questionNumber}`);
      console.log(`   - Opciones: ${randomQuestion.options.length}`);
      console.log(`   - Respuesta correcta: ${randomQuestion.correctAnswerIndex}`);
    } else {
      console.error('‚ùå No se pudo obtener pregunta aleatoria');
      return;
    }
    
    // Test 3: Verificar disponibilidad del sistema
    console.log('\nüìã Test 3: Verificando disponibilidad del sistema...');
    const availability = await Examen2024Service.isSystemAvailable();
    
    if (availability.available) {
      console.log('‚úÖ Sistema disponible');
    } else {
      console.error(`‚ùå Sistema no disponible: ${availability.message}`);
      return;
    }
    
    // Test 4: Verificar que se puede crear un simulacro (sin completarlo)
    console.log('\nüìã Test 4: Verificando capacidad de crear simulacro...');
    const testUserId = 'test_user_123';
    
    // Primero crear usuario de prueba si no existe
    const user = await prisma.telegramUser.upsert({
      where: { telegramUserId: testUserId },
      update: {},
      create: {
        telegramUserId: testUserId,
        firstName: 'Test User',
        username: 'testuser'
      }
    });
    
    const canStart = await Simulacro2024Service.canStartSimulacro(testUserId);
    
    if (canStart.canStart) {
      console.log('‚úÖ Puede crear simulacro 2024');
    } else {
      console.log(`‚ö†Ô∏è  No puede crear simulacro: ${canStart.reason}`);
    }
    
    // Test 5: Verificar estructura de la base de datos
    console.log('\nüìã Test 5: Verificando estructura de la base de datos...');
    
    // Verificar que las tablas necesarias existen
    const examen2018Count = await prisma.examenOficial2018.count();
    const simulacroCount = await prisma.simulacro.count();
    
    console.log(`‚úÖ Examen 2018: ${examen2018Count} preguntas`);
    console.log(`‚úÖ Examen 2024: ${questionCount} preguntas`);
    console.log(`‚úÖ Simulacros en BD: ${simulacroCount}`);
    
    // Test 6: Verificar que las preguntas tienen las respuestas correctas
    console.log('\nüìã Test 6: Verificando integridad de respuestas...');
    
    const sampledQuestions = await prisma.examenOficial2024.findMany({
      take: 5,
      orderBy: { questionNumber: 'asc' }
    });
    
    let integrityIssues = 0;
    
    for (const q of sampledQuestions) {
      if (q.correctAnswerIndex < 0 || q.correctAnswerIndex >= q.options.length) {
        console.error(`‚ùå Pregunta ${q.questionNumber}: √çndice de respuesta inv√°lido (${q.correctAnswerIndex})`);
        integrityIssues++;
      }
      if (q.options.length !== 4) {
        console.error(`‚ùå Pregunta ${q.questionNumber}: No tiene 4 opciones (${q.options.length})`);
        integrityIssues++;
      }
    }
    
    if (integrityIssues === 0) {
      console.log('‚úÖ Integridad de respuestas verificada (muestra de 5 preguntas)');
    } else {
      console.error(`‚ùå Se encontraron ${integrityIssues} problemas de integridad`);
    }
    
    // Cleanup: Eliminar usuario de prueba
    await prisma.telegramUser.delete({
      where: { telegramUserId: testUserId }
    }).catch(() => {}); // Ignorar si no existe
    
    console.log('\nüéâ PRUEBA COMPLETADA');
    console.log('‚úÖ La integraci√≥n del Examen 2024 est√° funcionando correctamente');
    
    // Resumen final
    console.log('\nüìä RESUMEN:');
    console.log(`üìù Total preguntas 2024: ${questionCount}`);
    console.log(`üìù Total preguntas 2018: ${examen2018Count}`);
    console.log(`üìù Total simulacros: ${simulacroCount}`);
    console.log('üöÄ Sistema listo para producci√≥n');
    
  } catch (error) {
    console.error('‚ùå ERROR EN LA PRUEBA:', error);
    throw error;
  } finally {
    await prisma.$disconnect();
  }
}

// Ejecutar prueba
testExamen2024Integration()
  .then(() => {
    console.log('\n‚úÖ Todas las pruebas pasaron exitosamente');
    process.exit(0);
  })
  .catch((error) => {
    console.error('\n‚ùå Error en las pruebas:', error);
    process.exit(1);
  }); 