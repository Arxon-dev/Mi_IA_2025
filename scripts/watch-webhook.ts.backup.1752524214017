import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function watchRecentActivity() {
  console.log('ğŸ‘€ MONITOR DE ACTIVIDAD EN TIEMPO REAL');
  console.log('======================================');
  console.log('');
  
  try {
    // Buscar actividad de los Ãºltimos 5 minutos
    const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
    
    // Respuestas recientes
    const recentResponses = await prisma.telegramResponse.findMany({
      where: {
        answeredAt: { gte: fiveMinutesAgo }
      },
      include: {
        user: {
          select: {
            firstName: true,
            lastName: true,
            username: true
          }
        }
      },
      orderBy: { answeredAt: 'desc' },
      take: 10
    });
    
    // Polls recientes
    const recentPolls = await prisma.telegramPoll.findMany({
      where: {
        sentAt: { gte: fiveMinutesAgo }
      },
      orderBy: { sentAt: 'desc' },
      take: 5
    });
    
    // Logs de envÃ­o recientes
    const recentSendLogs = await prisma.telegramSendLog.findMany({
      where: {
        sendTime: { gte: fiveMinutesAgo }
      },
      orderBy: { sendTime: 'desc' },
      take: 5
    });
    
    console.log('â° ACTIVIDAD ÃšLTIMOS 5 MINUTOS:');
    console.log('--------------------------------');
    console.log(`ğŸ“Š Fecha actual: ${new Date().toLocaleString()}`);
    console.log(`ğŸ” Buscando desde: ${fiveMinutesAgo.toLocaleString()}`);
    console.log('');
    
    if (recentResponses.length > 0) {
      console.log('ğŸ’¬ RESPUESTAS RECIENTES:');
      console.log('------------------------');
      recentResponses.forEach((response, index) => {
        const userName = `${response.user.firstName} ${response.user.lastName || ''}`.trim() || response.user.username || 'Usuario';
        const status = response.isCorrect ? 'âœ… CORRECTO' : 'âŒ INCORRECTO';
        console.log(`${index + 1}. ${userName}`);
        console.log(`   ${status} | +${response.points} puntos`);
        console.log(`   â° ${response.answeredAt.toLocaleString()}`);
        console.log('');
      });
    } else {
      console.log('ğŸ’¬ No hay respuestas en los Ãºltimos 5 minutos');
      console.log('');
    }
    
    if (recentPolls.length > 0) {
      console.log('ğŸ—³ï¸  POLLS ENVIADOS RECIENTEMENTE:');
      console.log('---------------------------------');
      recentPolls.forEach((poll, index) => {
        console.log(`${index + 1}. Poll ID: ${poll.pollId}`);
        console.log(`   ğŸ“‹ Pregunta: ${poll.questionId}`);
        console.log(`   â° ${poll.sentAt.toLocaleString()}`);
        console.log('');
      });
    } else {
      console.log('ğŸ—³ï¸  No hay polls enviados en los Ãºltimos 5 minutos');
      console.log('');
    }
    
    if (recentSendLogs.length > 0) {
      console.log('ğŸ“¤ LOGS DE ENVÃO RECIENTES:');
      console.log('---------------------------');
      recentSendLogs.forEach((log, index) => {
        const status = log.success ? 'âœ… Ã‰XITO' : 'âŒ ERROR';
        console.log(`${index + 1}. ${status} | Pregunta: ${log.questionId.substring(0, 8)}...`);
        console.log(`   â° ${log.sendTime.toLocaleString()}`);
        if (log.errorMessage) {
          console.log(`   âŒ Error: ${log.errorMessage}`);
        }
        console.log('');
      });
    }
    
    // EstadÃ­sticas rÃ¡pidas
    const totalUsers = await prisma.telegramUser.count();
    const totalResponses = await prisma.telegramResponse.count();
    
    console.log('ğŸ“Š ESTADÃSTICAS ACTUALES:');
    console.log('-------------------------');
    console.log(`ğŸ‘¥ Total usuarios: ${totalUsers}`);
    console.log(`ğŸ’¬ Total respuestas: ${totalResponses}`);
    console.log(`ğŸ—³ï¸  Polls activos: ${recentPolls.length}`);
    console.log('');
    
    console.log('ğŸ”„ Para monitorear de nuevo: npx tsx scripts/watch-webhook.ts');
    console.log('ğŸ“Š Para ver estadÃ­sticas completas: npx tsx scripts/monitor-system.ts');
    
  } catch (error) {
    console.error('âŒ Error monitoreando actividad:', error);
  } finally {
    await prisma.$disconnect();
  }
}

async function main() {
  const args = process.argv.slice(2);
  
  if (args.includes('--help')) {
    console.log('ğŸ‘€ MONITOR DE ACTIVIDAD:');
    console.log('');
    console.log('  ğŸ” Ver actividad reciente (Ãºltimos 5 minutos):');
    console.log('     npx tsx scripts/watch-webhook.ts');
    console.log('');
    console.log('  ğŸ“‹ Mostrar ayuda:');
    console.log('     npx tsx scripts/watch-webhook.ts --help');
    console.log('');
    console.log('ğŸ¯ QUÃ‰ MONITOREA:');
    console.log('   â€¢ Respuestas de usuarios a polls');
    console.log('   â€¢ Polls enviados recientemente');
    console.log('   â€¢ Logs de envÃ­o y errores');
    console.log('   â€¢ EstadÃ­sticas actuales');
    return;
  }
  
  await watchRecentActivity();
}

main(); 