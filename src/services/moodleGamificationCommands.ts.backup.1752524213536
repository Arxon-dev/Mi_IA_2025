import { MoodleGamificationService } from './moodleGamificationService';
import { checkMilitarySimulationPermission } from './militarySimulationPermissions';

// ==========================================
// ğŸ“ COMANDOS DE INTEGRACIÃ“N MOODLE
// ==========================================

/**
 * Comando /codigo_moodle - Generar cÃ³digo de verificaciÃ³n
 */
export async function handleVincularMoodleCommand(userId: string, fromUser: any): Promise<string | null> {
  try {
    console.log('ğŸ”— VINCULAR_MOODLE COMMAND - Generar cÃ³digo de verificaciÃ³n');

    // Verificar que el usuario no ya tenga cuenta vinculada
    const isLinked = await MoodleGamificationService.isUserLinked(userId);
    
    if (isLinked) {
      return `ğŸ”— **YA TIENES CUENTA VINCULADA**

ğŸ“ Tu cuenta de Moodle ya estÃ¡ conectada con tu progreso de Telegram.

ğŸ“Š Usa /estadisticas_unificadas para ver tu progreso conjunto.

ğŸ’¡ Si necesitas cambiar la vinculaciÃ³n, contacta @Carlos_esp`;
    }

    // Generar cÃ³digo de verificaciÃ³n
    const { code, expiresAt } = await MoodleGamificationService.generateVerificationCode(userId);
    
    const expiresIn = Math.floor((expiresAt.getTime() - Date.now()) / (1000 * 60)); // minutos

    return `ğŸ“ <b>VINCULAR CUENTA MOODLE</b>

ğŸ”— Para conectar tu cuenta de Moodle con Telegram y <b>unificar tu gamificaciÃ³n</b>, sigue estos pasos:

<b>ğŸ“‹ PASO 1: Copia tu cÃ³digo de verificaciÃ³n</b>
\`\`\`
${code}
\`\`\`

<b>ğŸŒ PASO 2: Ve a tu plataforma Moodle</b>
â€¢ Entra a tu academia Moodle
â€¢ Ve a tu perfil de usuario
â€¢ Busca la secciÃ³n "IntegraciÃ³n Telegram"
â€¢ Ingresa el cÃ³digo: <b>${code}</b>

<b>â° IMPORTANTE:</b>
â€¢ El cÃ³digo expira en <b>${expiresIn} minutos</b>
â€¢ Solo puedes usarlo una vez
â€¢ AsegÃºrate de estar en tu cuenta correcta de Moodle

<b>ğŸ® UNA VEZ VINCULADO:</b>
âœ… Tus puntos de Moodle se sumarÃ¡n automÃ¡ticamente
âœ… Mismo nivel y ranking unificado  
âœ… EstadÃ­sticas combinadas de ambas plataformas
âœ… Progreso sincronizado en tiempo real

ğŸ’¡ Â¿Dudas? Contacta @Carlos_esp`;

  } catch (error) {
    console.error('âŒ Error en comando vincular_moodle:', error);
    return `âŒ <b>Error generando cÃ³digo de verificaciÃ³n</b>

IntÃ©ntalo de nuevo en unos momentos.

Si el problema persiste, contacta @Carlos_esp`;
  }
}

/**
 * Comando /estado_moodle - Ver estado de vinculaciÃ³n
 */
export async function handleEstadoMoodleCommand(userId: string, fromUser: any): Promise<string | null> {
  try {
    console.log('ğŸ“Š ESTADO_MOODLE COMMAND - Ver estado de vinculaciÃ³n');

    const isLinked = await MoodleGamificationService.isUserLinked(userId);
    
    if (!isLinked) {
      return `ğŸ”— <b>CUENTA NO VINCULADA</b>

âŒ Tu cuenta de Moodle no estÃ¡ conectada con Telegram.

ğŸš€ <b>Para vincular:</b>
â€¢ Ve a la url https://campus.opomelilla.com/local/telegram_integration/verify.php para generar tu cÃ³digo
â€¢ Usa el comando /codigo_moodle
â€¢ Sigue las instrucciones del cÃ³digo

ğŸ® <b>Beneficios de vincular:</b>
âœ… GamificaciÃ³n unificada Telegram + Moodle
âœ… EstadÃ­sticas combinadas automÃ¡ticas
âœ… Mismo nivel y ranking en ambas plataformas
âœ… Progreso sincronizado en tiempo real

ğŸ’¡ Â¿Dudas? Contacta @Carlos_esp`;
    }

    // Obtener estadÃ­sticas unificadas
    const unifiedStats = await MoodleGamificationService.getUnifiedStats(userId);

    return `ğŸ“ <b>CUENTA MOODLE VINCULADA</b> âœ…

ğŸ”— <b>Estado:</b> Conectada y sincronizada
âš¡ <b>SincronizaciÃ³n:</b> AutomÃ¡tica en tiempo real

ğŸ“Š <b>ESTADÃSTICAS UNIFICADAS:</b>

ğŸ® <b>Telegram:</b>
â€¢ Preguntas: ${unifiedStats.unified.platforms.telegram.questions}
â€¢ Correctas: ${unifiedStats.unified.platforms.telegram.correct}
â€¢ Incorrectas: ${unifiedStats.unified.platforms.telegram.questions - unifiedStats.unified.platforms.telegram.correct}
â€¢ PrecisiÃ³n: ${unifiedStats.unified.platforms.telegram.accuracy.toFixed(1)}%

ğŸ“ <b>Moodle:</b>
â€¢ Preguntas: ${unifiedStats.unified.platforms.moodle.questions}
â€¢ Correctas: ${unifiedStats.unified.platforms.moodle.correct}
â€¢ Incorrectas: ${unifiedStats.unified.platforms.moodle.questions - unifiedStats.unified.platforms.moodle.correct}
â€¢ PrecisiÃ³n: ${unifiedStats.unified.platforms.moodle.accuracy.toFixed(1)}%

ğŸ† <b>TOTALES COMBINADOS:</b>
â€¢ Preguntas: ${unifiedStats.unified.totalQuestions}
â€¢ Correctas: ${unifiedStats.unified.totalCorrect}
â€¢ Incorrectas: ${unifiedStats.unified.totalQuestions - unifiedStats.unified.totalCorrect}
â€¢ Puntos: ${unifiedStats.unified.telegramPoints}
â€¢ Nivel: ${unifiedStats.unified.level}
â€¢ Ranking: #${unifiedStats.unified.rank}

ğŸ’¡ /estadisticas_unificadas - Ver reporte completo`;

  } catch (error) {
    console.error('âŒ Error en comando estado_moodle:', error);
    return `âŒ <b>Error obteniendo estado</b>

IntÃ©ntalo de nuevo en unos momentos.

Si el problema persiste, contacta @Carlos_esp`;
  }
}

/**
 * Comando /estadisticas_unificadas - Ver estadÃ­sticas detalladas combinadas
 */
export async function handleEstadisticasUnificadasCommand(userId: string, fromUser: any): Promise<string | null> {
  try {
    console.log('ğŸ“ˆ ESTADISTICAS_UNIFICADAS COMMAND - Ver estadÃ­sticas completas');

    // Verificar permisos Premium (esta funciÃ³n es Premium)
    const permission = await checkMilitarySimulationPermission(userId);
    
    if (!permission.allowed) {
      return `ğŸ¥ˆ <b>Las estadÃ­sticas unificadas requieren plan Premium</b>

ğŸ“‹ <b>Plan actual:</b> Gratuito
ğŸš€ <b>SoluciÃ³n:</b> Upgrade a plan Premium

ğŸ’° <b>OPCIONES DISPONIBLES:</b>
ğŸ¥‰ /basico - Plan BÃ¡sico (â‚¬4.99/mes)
ğŸ¥ˆ /premium - Plan Premium (â‚¬9.99/mes)
ğŸ“‹ /planes - Ver comparativa completa

ğŸ’¡ **Â¿Dudas?** Contacta @Carlos_esp`;
    }

    const isLinked = await MoodleGamificationService.isUserLinked(userId);
    
    if (!isLinked) {
      return `ğŸ”— **Cuenta Moodle no vinculada**

Para ver estadÃ­sticas unificadas necesitas:
1. Vincular tu cuenta de Moodle: /codigo_moodle
2. Volver a ejecutar este comando

ğŸ’¡ **Â¿Dudas?** Contacta @Carlos_esp`;
    }

    const unifiedStats = await MoodleGamificationService.getUnifiedStats(userId);

    // Calcular precisiÃ³n global
    const globalAccuracy = unifiedStats.unified.totalQuestions > 0 ? 
      (unifiedStats.unified.totalCorrect / unifiedStats.unified.totalQuestions) * 100 : 0;

    // Determinar mejor plataforma
    const telegramAcc = unifiedStats.unified.platforms.telegram.accuracy;
    const moodleAcc = unifiedStats.unified.platforms.moodle.accuracy;
    let betterPlatform = 'Equilibrado';
    
    if (telegramAcc > moodleAcc + 5) {
      betterPlatform = 'ğŸ“± Telegram';
    } else if (moodleAcc > telegramAcc + 5) {
      betterPlatform = 'ğŸ“ Moodle';
    }

    return `ğŸ“Š <b>ESTADÃSTICAS UNIFICADAS PREMIUM</b> ğŸ¥ˆ

ğŸ‘¤ <b>${fromUser.first_name || 'Usuario'}</b>
ğŸ† <b>Nivel ${unifiedStats.unified.level}</b> | <b>Ranking #${unifiedStats.unified.rank}</b>

ğŸ“± <b>TELEGRAM:</b>
â€¢ Preguntas respondidas: <b>${unifiedStats.unified.platforms.telegram.questions}</b>
â€¢ Respuestas correctas: <b>${unifiedStats.unified.platforms.telegram.correct}</b>
â€¢ Respuestas incorrectas: <b>${unifiedStats.unified.platforms.telegram.questions - unifiedStats.unified.platforms.telegram.correct}</b>
â€¢ PrecisiÃ³n: <b>${telegramAcc.toFixed(1)}%</b>

ğŸ“ <b>MOODLE:</b>
â€¢ Preguntas respondidas: <b>${unifiedStats.unified.platforms.moodle.questions}</b>
â€¢ Respuestas correctas: <b>${unifiedStats.unified.platforms.moodle.correct}</b>
â€¢ Respuestas incorrectas: <b>${unifiedStats.unified.platforms.moodle.questions - unifiedStats.unified.platforms.moodle.correct}</b>
â€¢ PrecisiÃ³n: <b>${moodleAcc.toFixed(1)}%</b>

ğŸŒŸ <b>TOTALES GLOBALES:</b>
â€¢ <b>${unifiedStats.unified.totalQuestions}</b> preguntas totales
â€¢ <b>${unifiedStats.unified.totalCorrect}</b> respuestas correctas
â€¢ <b>${unifiedStats.unified.totalQuestions - unifiedStats.unified.totalCorrect}</b> respuestas incorrectas
â€¢ <b>${globalAccuracy.toFixed(1)}%</b> precisiÃ³n global
â€¢ <b>${unifiedStats.unified.telegramPoints}</b> puntos acumulados

ğŸ¯ <b>ANÃLISIS:</b>
â€¢ Mejor rendimiento en: <b>${betterPlatform}</b>
â€¢ DistribuciÃ³n: ${Math.round((unifiedStats.unified.platforms.telegram.questions / unifiedStats.unified.totalQuestions) * 100)}% Telegram, ${Math.round((unifiedStats.unified.platforms.moodle.questions / unifiedStats.unified.totalQuestions) * 100)}% Moodle

ğŸ’¡ <b>RECOMENDACIONES:</b>
${telegramAcc > moodleAcc ? 'â€¢ ContinÃºa practicando en Moodle para mejorar' : 'â€¢ Usa mÃ¡s Telegram para afianzar conocimientos'}
${globalAccuracy < 70 ? 'â€¢ EnfÃ³cate en mejorar la precisiÃ³n global' : 'â€¢ Â¡Excelente rendimiento mantenido!'}

ğŸ”„ <b>SincronizaciÃ³n:</b> AutomÃ¡tica en tiempo real
ğŸ“± /estado_moodle - Ver estado de conexiÃ³n`;

  } catch (error) {
    console.error('âŒ Error en comando estadisticas_unificadas:', error);
    return `âŒ <b>Error obteniendo estadÃ­sticas</b>

IntÃ©ntalo de nuevo en unos momentos.

Si el problema persiste, contacta @Carlos_esp`;
  }
}

/**
 * Comando /sincronizar_moodle - SincronizaciÃ³n manual de actividades
 */
export async function handleSincronizarMoodleCommand(userId: string, fromUser: any): Promise<string | null> {
  try {
    console.log('ğŸ”„ SINCRONIZAR_MOODLE COMMAND - SincronizaciÃ³n manual de actividades');

    const isLinked = await MoodleGamificationService.isUserLinked(userId);
    
    if (!isLinked) {
      return `ğŸ”— **Cuenta no vinculada**

âŒ Necesitas vincular tu cuenta de Moodle primero.

ğŸš€ **Para vincular:**
â€¢ Usa el comando /codigo_moodle
â€¢ Sigue las instrucciones en https://campus.opomelilla.com/local/telegram_integration/verify.php

ğŸ’¡ Â¿Dudas? Contacta @Carlos_esp`;
    }

    // Llamar al endpoint de sincronizaciÃ³n manual
    const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000';
    const syncResponse = await fetch(`${baseUrl}/api/moodle/manual-sync`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        telegramUserId: userId,
        forceSync: false
      })
    });

    const syncResult = await syncResponse.json();

    if (!syncResult.success) {
      return `âŒ **Error en sincronizaciÃ³n**

${syncResult.message}

ğŸ”„ **IntÃ©ntalo de nuevo en unos momentos.**

ğŸ’¡ Si persiste el problema, contacta @Carlos_esp`;
    }

    if (syncResult.syncedActivities === 0) {
      return `âœ… **SincronizaciÃ³n completada**

ğŸ“Š **No hay actividades nuevas para sincronizar**

ğŸ•’ **Ãšltima sincronizaciÃ³n:** Hace unos minutos

ğŸ’¡ Tus actividades ya estÃ¡n actualizadas. Usa /estado_moodle para ver tus estadÃ­sticas.`;
    }

    return `ğŸ‰ **Â¡SincronizaciÃ³n exitosa!**

ğŸ“Š **Actividades sincronizadas:**
â€¢ ${syncResult.totalQuestions} preguntas nuevas
â€¢ ${syncResult.syncedActivities} quizzes procesados

âœ… **Estado:** Todas las actividades actualizadas

ğŸ® **PrÃ³ximos pasos:**
â€¢ /estado_moodle - Ver estadÃ­sticas actualizadas
â€¢ /estadisticas_unificadas - Ver reporte completo

ğŸ’¡ Tus puntos y estadÃ­sticas se han actualizado automÃ¡ticamente.`;

  } catch (error) {
    console.error('âŒ Error en comando sincronizar_moodle:', error);
    return `âŒ **Error en sincronizaciÃ³n**

IntÃ©ntalo de nuevo en unos momentos.

Si el problema persiste, contacta @Carlos_esp`;
  }
}

/**
 * Comando /codigo_moodle - Introducir cÃ³digo generado en Moodle
 */
export async function handleCodigoMoodleCommand(userId: string, code: string, fromUser: any): Promise<string | null> {
  try {
    console.log('ğŸ”‘ CODIGO_MOODLE COMMAND - Introducir cÃ³digo de Moodle');

    // Verificar que el usuario no ya tenga cuenta vinculada
    const isLinked = await MoodleGamificationService.isUserLinked(userId);
    
    if (isLinked) {
      return `ğŸ”— **YA TIENES CUENTA VINCULADA**

ğŸ“ Tu cuenta de Moodle ya estÃ¡ conectada con tu progreso de Telegram.

ğŸ“Š Usa /estadisticas_unificadas para ver tu progreso conjunto.

ğŸ’¡ Si necesitas cambiar la vinculaciÃ³n, contacta @Carlos_esp`;
    }

    if (!code || code.length !== 6) {
      return `âŒ <b>CÃ³digo invÃ¡lido</b>

El cÃ³digo debe tener exactamente 6 caracteres.

<b>ğŸ“‹ Formato correcto:</b>
\`/codigo_moodle ABC123\`

ğŸ’¡ Genera un nuevo cÃ³digo en tu plataforma Moodle si es necesario.`;
    }

    // Verificar el cÃ³digo con la API de Moodle
    const verification = await MoodleGamificationService.verifyMoodleCode(code, userId, fromUser);
    
    if (!verification.success) {
      return `âŒ <b>CÃ³digo no vÃ¡lido o expirado</b>

${verification.message}

<b>ğŸ”„ Soluciones:</b>
â€¢ Genera un nuevo cÃ³digo en Moodle
â€¢ Verifica que el cÃ³digo sea correcto
â€¢ AsegÃºrate de que no haya expirado

ğŸ’¡ Los cÃ³digos expiran en 15 minutos.`;
    }

    return `ğŸ‰ <b>Â¡VINCULACIÃ“N EXITOSA!</b> âœ…

ğŸ”— <b>Tu cuenta de Moodle ya estÃ¡ conectada con Telegram</b>

ğŸ® <b>BENEFICIOS ACTIVADOS:</b>
âœ… GamificaciÃ³n unificada automÃ¡tica
âœ… Puntos sincronizados en tiempo real
âœ… Mismo nivel y ranking en ambas plataformas
âœ… EstadÃ­sticas combinadas Premium

ğŸ“Š <b>COMANDOS DISPONIBLES:</b>
â€¢ /estado_moodle - Ver estado de conexiÃ³n
â€¢ /estadisticas_unificadas - Reporte completo (Premium)

ğŸš€ <b>Â¡Ahora cuando respondas quizzes en Moodle, tus puntos se actualizarÃ¡n automÃ¡ticamente en Telegram!</b>

ğŸ’¡ Â¿Dudas? Contacta @Carlos_esp`;

  } catch (error) {
    console.error('âŒ Error en comando codigo_moodle:', error);
    return `âŒ <b>Error procesando cÃ³digo</b>

IntÃ©ntalo de nuevo en unos momentos.

Si el problema persiste, contacta @Carlos_esp`;
  }
} 